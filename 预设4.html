<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>API 配置中心</title>
    
    <div id="font-link-container">
        <link rel="preload" as="style" crossorigin
            href="https://fontsapi.zeoseven.com/309/main/result.css"
            onload="this.rel='stylesheet'"
            onerror="this.href='httpsapi-storage.zeoseven.com/309/main/result.css'" />
        <noscript>
            <link rel="stylesheet" href="https://fontsapi.zeoseven.com/309/main/result.css" />
        </noscript>
    </div>

    <style>
        :root {
            --screen-bg: #f7f9f7;
            --text-color: #5a6e60;
            --text-light: #a2b0a5;
            --placeholder-bg: #e8f0e9;
            --battery-low: #e74c3c;
            --battery-charging: #34c759;
            --font-main: "KingHwaOldSong", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            --global-font-size: 16px; 
            --global-font-weight: 400;
        }

        /* 修正2: 固定布局，防止键盘顶起底部栏 */
        html, body {
            margin: 0; padding: 0; width: 100%; height: 100%; /* 使用100%替代vh */
            overflow: hidden; /* 防止body出现滚动条 */
            background-color: var(--screen-bg);
            font-family: var(--font-main);
            color: var(--text-color);
            font-size: var(--global-font-size);
            font-weight: var(--global-font-weight);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .app-container {
            width: 100%;
            height: 100%; /* 继承父级的高度 */
            max-width: 420px;
            max-height: 850px;
            display: flex;
            flex-direction: column;
            background-color: var(--placeholder-bg);
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            border-radius: 20px;
            overflow: hidden;
        }

        .app-header { 
            padding: 5px 20px; 
            text-align: center; 
            flex-shrink: 0; 
            margin-top: 25px;
        }
        .app-title { 
            font-size: 1.1em;
            font-weight: bold; 
        }

        .page-container {
            flex-grow: 1;
            overflow-y: auto;
            padding: 15px 20px;
        }
        .page-container::-webkit-scrollbar { display: none; }

        .page-view { display: none; }
        .page-view.active { display: block; }

        .settings-section { 
            background-color: #fff; 
            border-radius: 15px; 
            padding: 15px 20px; 
            margin-bottom: 20px; 
            box-shadow: 0 4px 15px rgba(90, 110, 96, 0.08);
        }
        .control-group { margin-bottom: 20px; }
        .control-group:last-child { margin-bottom: 5px; }
        .control-group label { display: block; font-size: 0.875em; margin-bottom: 8px; color: var(--text-light); }
        
        .btn { display: block; width: 100%; padding: 12px; background-color: var(--placeholder-bg); border: none; border-radius: 10px; font-family: var(--font-main); color: var(--text-color); font-size: 0.9375em; cursor: pointer; text-align: center; transition: background-color 0.2s, opacity 0.2s; }
        .btn:hover { background-color: #dce6dd; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; background-color: var(--placeholder-bg); }
        
        .input-field, .textarea-field, .select-field { width: 100%; padding: 12px; border: 1px solid #e0e0e0; border-radius: 10px; box-sizing: border-box; font-family: var(--font-main); font-size: 0.9em; background-color: #fdfdfd; transition: border-color 0.2s, box-shadow 0.2s; }
        .input-field:focus, .textarea-field:focus, .select-field:focus { outline: none; border-color: var(--text-color); box-shadow: 0 0 8px rgba(90, 110, 96, 0.15); }
        
        .textarea-field { resize: vertical; min-height: 100px; }
        .btn-restore { background-color: #e8e8e8; margin-top: 10px; }
        .input-with-button { display: flex; align-items: center; gap: 10px; }
        .input-with-button .input-field { flex-grow: 1; }
        .input-with-button .btn-icon { padding: 10px; line-height: 0; background-color: var(--placeholder-bg); border-radius: 10px; cursor: pointer; border: none; }
        .input-with-button .btn-icon svg { width: 20px; height: 20px; fill: var(--text-color); }
        
        #connection-status { margin-top: 15px; text-align: center; font-size: 0.9em; min-height: 1.2em; transition: color 0.3s; }
        #connection-status.success { color: var(--battery-charging); }
        #connection-status.error { color: var(--battery-low); }

        .app-footer {
            flex-shrink: 0;
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            background-color: #fff;
            box-shadow: 0 -5px 20px rgba(90, 110, 96, 0.08);
            border-top: 1px solid #f0f0f0;
        }
        .nav-btn {
            background: none;
            border: none;
            font-family: var(--font-main);
            font-size: 0.9em;
            color: var(--text-light);
            cursor: pointer;
            padding: 5px 15px;
            border-radius: 8px;
            transition: color 0.2s, background-color 0.2s;
        }
        .nav-btn.active {
            color: var(--text-color);
            font-weight: bold;
            background-color: var(--placeholder-bg);
        }

        .preset-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin-bottom: 10px;
            background-color: #fdfdfd;
            border-radius: 10px;
            border: 1px solid #e8f0e9;
        }
        .preset-name {
            font-weight: bold;
            margin-right: 15px;
        }
        .preset-actions {
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }
        .preset-actions .btn-sm {
            padding: 6px 12px;
            font-size: 0.85em;
            min-width: 60px;
        }
        .btn-delete { background-color: #fbeae8; color: var(--battery-low); }

        .custom-prompt-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.4);
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
            z-index: 1000;
        }
        .custom-prompt-overlay.visible {
            opacity: 1;
            visibility: visible;
        }
        .custom-prompt-box {
            background-color: var(--screen-bg);
            padding: 25px;
            border-radius: 15px;
            width: 80%;
            max-width: 320px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transform: scale(0.95);
            transition: transform 0.2s;
        }
        .custom-prompt-overlay.visible .custom-prompt-box {
            transform: scale(1);
        }
        .custom-prompt-box h3 {
            margin: 0 0 15px 0;
            font-size: 1.1em;
            color: var(--text-color);
        }
        .custom-prompt-box .input-field {
            margin-bottom: 20px;
        }
        .custom-prompt-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        .custom-prompt-buttons .btn {
            width: auto;
            padding: 8px 20px;
        }
        .custom-prompt-buttons .btn-primary {
            background-color: var(--text-color);
            color: white;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="app-header">
            <h2 class="app-title" id="app-page-title">API 配置</h2>
        </header>

        <div class="page-container">
            <div id="config-page" class="page-view active">
                <!-- 配置页面内容... -->
                <div class="settings-section">
                    <div class="control-group">
                        <label for="api-provider-select">服务商</label>
                        <select id="api-provider-select" class="select-field">
                            <option value="openai">OpenAI</option>
                            <option value="gemini">Gemini</option>
                            <option value="deepseek">DeepSeek</option>
                            <option value="claude">Claude</option>
                            <option value="reverse_proxy">反向代理</option>
                            <option value="custom">自定义 (OpenAI 格式)</option>
                            <option value="polling">轮询</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label for="api-url-input">API URL</label>
                        <input type="text" id="api-url-input" class="input-field">
                    </div>
                    <div class="control-group">
                        <label for="api-key-input">API Key</label>
                        <div class="input-with-button">
                            <input type="password" id="api-key-input" class="input-field">
                            <textarea id="api-key-textarea" class="textarea-field" style="display: none;" placeholder="每行输入一个 Key"></textarea>
                            <button id="toggle-api-key-visibility" class="btn-icon">
                                <svg viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"></path></svg>
                            </button>
                        </div>
                    </div>
                    <div class="control-group">
                        <label for="api-model-select">模型</label>
                        <select id="api-model-select" class="select-field"></select>
                    </div>
                </div>
                <div class="settings-section">
                    <button class="btn" id="test-connection-btn">连接测试 & 拉取模型</button>
                    <p id="connection-status"></p>
                </div>
                <div class="settings-section">
                    <button class="btn" id="save-api-settings-btn" style="background-color: var(--text-color); color: white;">保存设置</button>
                    <button class="btn btn-restore" id="restore-api-defaults-btn">恢复默认</button>
                </div>
            </div>
            <div id="presets-page" class="page-view">
                <div id="presets-list-container"></div>
            </div>
        </div>

        <footer class="app-footer">
            <button id="nav-config-btn" class="nav-btn active">配置</button>
            <button id="nav-presets-btn" class="nav-btn">预设</button>
        </footer>
    </div>

    <div id="custom-prompt" class="custom-prompt-overlay">
        <div class="custom-prompt-box">
            <h3 id="custom-prompt-title">为预设命名</h3>
            <input type="text" id="custom-prompt-input" class="input-field" placeholder="请输入名称">
            <div class="custom-prompt-buttons">
                <button id="custom-prompt-cancel" class="btn">取消</button>
                <button id="custom-prompt-confirm" class="btn btn-primary">保存</button>
            </div>
        </div>
    </div>

    <script>
        // 修正1: 修复致命的语法错误 '=>'
        document.addEventListener('DOMContentLoaded', () => {
            const apiControls = { provider: document.getElementById('api-provider-select'), urlInput: document.getElementById('api-url-input'), keyInput: document.getElementById('api-key-input'), keyTextarea: document.getElementById('api-key-textarea'), toggleKey: document.getElementById('toggle-api-key-visibility'), model: document.getElementById('api-model-select'), testBtn: document.getElementById('test-connection-btn'), saveBtn: document.getElementById('save-api-settings-btn'), restoreBtn: document.getElementById('restore-api-defaults-btn'), status: document.getElementById('connection-status'), };
            const pageControls = { title: document.getElementById('app-page-title'), configPage: document.getElementById('config-page'), presetsPage: document.getElementById('presets-page'), navConfigBtn: document.getElementById('nav-config-btn'), navPresetsBtn: document.getElementById('nav-presets-btn'), presetsListContainer: document.getElementById('presets-list-container') };
            const promptControls = { overlay: document.getElementById('custom-prompt'), title: document.getElementById('custom-prompt-title'), input: document.getElementById('custom-prompt-input'), cancelBtn: document.getElementById('custom-prompt-cancel'), confirmBtn: document.getElementById('custom-prompt-confirm'), };

            const CORS_PROXY_URL = 'https://corsproxy.io/?';
            const providerData = {
                openai:   { url: 'https://api.openai.com/v1',                     useProxy: true, testable: true },
                deepseek: { url: 'https://api.deepseek.com/v1',                   useProxy: true, testable: true },
                gemini:   { url: 'https://generativelanguage.googleapis.com/v1beta', useProxy: true, testable: false, modelsEndpoint: false },
                claude:   { url: 'https://api.anthropic.com/v1',                  useProxy: true, testable: false, modelsEndpoint: false },
                reverse_proxy: { url: '', useProxy: false, testable: true },
                custom:        { url: '', useProxy: false, testable: true },
                polling:       { url: '', useProxy: false, testable: true }
            };
            
            let promptResolve = null; function showCustomPrompt(title, placeholder) { promptControls.title.textContent = title; promptControls.input.placeholder = placeholder; promptControls.input.value = ''; promptControls.overlay.classList.add('visible'); promptControls.input.focus(); return new Promise(resolve => { promptResolve = resolve; }); } function hideCustomPrompt() { promptControls.overlay.classList.remove('visible'); promptResolve = null; } promptControls.confirmBtn.addEventListener('click', () => { if (promptResolve) promptResolve(promptControls.input.value); hideCustomPrompt(); }); promptControls.cancelBtn.addEventListener('click', () => { if (promptResolve) promptResolve(null); hideCustomPrompt(); }); promptControls.overlay.addEventListener('click', (e) => { if (e.target === promptControls.overlay) { if (promptResolve) promptResolve(null); hideCustomPrompt(); } });

            function showPage(pageName) {
                pageControls.configPage.classList.remove('active'); pageControls.presetsPage.classList.remove('active'); pageControls.navConfigBtn.classList.remove('active'); pageControls.navPresetsBtn.classList.remove('active');
                if (pageName === 'config') { pageControls.configPage.classList.add('active'); pageControls.navConfigBtn.classList.add('active'); pageControls.title.textContent = 'API 配置'; } 
                else if (pageName === 'presets') { pageControls.presetsPage.classList.add('active'); pageControls.navPresetsBtn.classList.add('active'); pageControls.title.textContent = '我的预设'; renderPresets(); }
            }

            function getPresets() { return JSON.parse(localStorage.getItem('apiPresets')) || []; }
            function savePresets(presets) { localStorage.setItem('apiPresets', JSON.stringify(presets)); }

            function renderPresets() {
                const presets = getPresets();
                pageControls.presetsListContainer.innerHTML = '';
                if (presets.length === 0) { pageControls.presetsListContainer.innerHTML = `<p style="text-align:center; color: var(--text-light);">暂无预设，请在“配置”页面连接成功后保存。</p>`; return; }
                presets.forEach((preset, index) => {
                    const item = document.createElement('div');
                    item.className = 'preset-list-item';
                    item.innerHTML = `<span class="preset-name">${preset.name}</span><div class="preset-actions"><button class="btn btn-sm btn-apply">应用</button><button class="btn btn-sm btn-delete">删除</button></div>`;
                    item.querySelector('.btn-apply').addEventListener('click', () => loadPreset(index));
                    item.querySelector('.btn-delete').addEventListener('click', () => deletePreset(index));
                    pageControls.presetsListContainer.appendChild(item);
                });
            }
            
            function loadPreset(index) {
                const presets = getPresets();
                if (presets[index]) {
                    applySettings(presets[index].settings);
                    alert(`预设 “${presets[index].name}” 已应用并加载模型！`);
                    showPage('config');
                }
            }

            function deletePreset(index) {
                const presets = getPresets();
                if (!confirm(`确定要删除预设 “${presets[index].name}” 吗？`)) return;
                presets.splice(index, 1);
                savePresets(presets);
                renderPresets();
            }
            
            async function fetchModels(url, key, useProxy) { apiControls.status.textContent = '正在拉取模型列表...'; apiControls.status.className = ''; try { const baseUrl = useProxy ? CORS_PROXY_URL + encodeURIComponent(url) : url; const finalUrl = `${baseUrl.replace(/\/$/, "")}/models`; const response = await fetch(finalUrl, { method: 'GET', headers: { 'Authorization': `Bearer ${key}`, 'Content-Type': 'application/json' }, mode: 'cors' }); if (!response.ok) { const errorText = await response.text(); throw new Error(`HTTP ${response.status}: ${errorText.slice(0, 100)}`); } const data = await response.json(); apiControls.status.textContent = '模型列表拉取成功！'; apiControls.status.classList.add('success'); const models = data.data || data; if (!Array.isArray(models)) throw new Error('返回数据格式不正确'); return models.map(model => model.id).sort(); } catch (error) { apiControls.status.textContent = `拉取失败: ${error.message}`; apiControls.status.classList.add('error'); return []; } }
            
            function updateControlsForProvider() { const provider = apiControls.provider.value; const data = providerData[provider]; apiControls.urlInput.value = data.url; const isPolling = provider === 'polling'; apiControls.keyInput.style.display = isPolling ? 'none' : 'block'; apiControls.keyTextarea.style.display = isPolling ? 'block' : 'none'; apiControls.toggleKey.style.display = isPolling ? 'none' : 'inline-block'; apiControls.model.innerHTML = ''; const placeholderText = data.modelsEndpoint === false ? '此服务商不支持自动拉取模型' : '请先进行连接测试来拉取模型'; const option = document.createElement('option'); option.textContent = placeholderText; apiControls.model.appendChild(option); }
            
            function getCurrentSettings(modelsList = []) {
                const provider = apiControls.provider.value;
                return {
                    provider: provider,
                    url: apiControls.urlInput.value,
                    key: provider === 'polling' ? apiControls.keyTextarea.value : apiControls.keyInput.value,
                    model: apiControls.model.value,
                    models: modelsList
                };
            }

            function applySettings(settings) {
                apiControls.provider.value = settings.provider || 'openai';
                updateControlsForProvider();
                apiControls.urlInput.value = settings.url;
                if (settings.provider === 'polling') {
                    apiControls.keyTextarea.value = settings.key;
                } else {
                    apiControls.keyInput.value = settings.key;
                }
                
                apiControls.model.innerHTML = '';
                if (settings.models && settings.models.length > 0) {
                    settings.models.forEach(modelName => {
                        const option = document.createElement('option');
                        option.value = modelName;
                        option.textContent = modelName;
                        apiControls.model.appendChild(option);
                    });
                    apiControls.status.textContent = '预设已应用，模型列表已加载。';
                    apiControls.status.className = 'success';
                } else {
                    const option = document.createElement('option');
                    option.textContent = '请先进行连接测试来拉取模型';
                    apiControls.model.appendChild(option);
                    apiControls.status.textContent = '';
                    apiControls.status.className = '';
                }
                apiControls.model.value = settings.model;
            }

            function saveCurrentSettings() {
                localStorage.setItem('apiSettings', JSON.stringify(getCurrentSettings()));
                alert('API 设置已保存!');
            }

            function loadLastSettings() {
                const settingsJSON = localStorage.getItem('apiSettings');
                if (settingsJSON) { applySettings(JSON.parse(settingsJSON)); } 
                else { updateControlsForProvider(); }
            }

            function isExistingPreset(currentSettings) {
                const presets = getPresets();
                return presets.some(p =>
                    p.settings.provider === currentSettings.provider &&
                    p.settings.url === currentSettings.url &&
                    p.settings.key === currentSettings.key
                );
            }

            async function testAndFetch() {
                const provider = apiControls.provider.value, config = providerData[provider];
                if (!config.testable) { apiControls.status.textContent = '此服务商不支持自动拉取模型。'; return; }
                const url = apiControls.urlInput.value.trim();
                let key = provider === 'polling' ? apiControls.keyTextarea.value.split('\n')[0].trim() : apiControls.keyInput.value.trim();
                if (!url || !key) { apiControls.status.textContent = 'URL 和 Key 不能为空。'; apiControls.status.classList.add('error'); return; }
                
                const currentConfigForCheck = getCurrentSettings();
                const models = await fetchModels(url, key, config.useProxy);
                
                if (models.length > 0) {
                    const currentModel = apiControls.model.value;
                    apiControls.model.innerHTML = '';
                    models.forEach(modelName => {
                        const option = document.createElement('option');
                        option.value = modelName; option.textContent = modelName;
                        apiControls.model.appendChild(option);
                    });
                    if (models.includes(currentModel)) { apiControls.model.value = currentModel; }

                    if (!isExistingPreset(currentConfigForCheck)) {
                        const presetName = await showCustomPrompt('连接成功！', '为此配置命名以保存为预设');
                        if (presetName && presetName.trim() !== '') {
                            const presets = getPresets();
                            const newPreset = { name: presetName.trim(), settings: getCurrentSettings(models) };
                            presets.push(newPreset);
                            savePresets(presets);
                            alert(`预设 “${presetName.trim()}” 已保存！`);
                        }
                    }
                }
            }

            // --- 事件监听器 ---
            pageControls.navConfigBtn.addEventListener('click', () => showPage('config'));
            pageControls.navPresetsBtn.addEventListener('click', () => showPage('presets'));
            apiControls.provider.addEventListener('change', updateControlsForProvider);
            apiControls.toggleKey.addEventListener('click', () => { apiControls.keyInput.type = apiControls.keyInput.type === 'password' ? 'text' : 'password'; });
            apiControls.saveBtn.addEventListener('click', saveCurrentSettings);
            apiControls.testBtn.addEventListener('click', testAndFetch);
            apiControls.restoreBtn.addEventListener('click', () => { localStorage.removeItem('apiSettings'); apiControls.provider.value = 'openai'; apiControls.keyInput.value = ''; apiControls.keyTextarea.value = ''; loadLastSettings(); alert('已恢复默认设置。'); });
            
            // --- 页面首次加载 ---
            loadLastSettings();
            showPage('config');
        });
    </script>
</body>
</html>